<!DOCTYPE html>
<html lang="zh-Hant">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

	<title>Booking Form HTML Template</title>

	<!-- 	Google font -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">

	<!-- Bootstrap -->
	<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />

	<!-- Custom stlylesheet -->
	<link type="text/css" rel="stylesheet" href="css/style.css" />

	<!-- Date -->
	<link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

</head>

<body>
	<div id="booking" class="section">
		<div class="section-center">
			<div class="container">
				<div class="row">
					<div class="col-md-7 col-md-push-5">
						<div class="booking-cta">
							<h1>Make your reservation</h1>
							<div id="checked"></div>
							<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Animi facere, soluta magnam
								consectetur molestias itaque
								ad sint fugit architecto incidunt iste culpa perspiciatis possimus voluptates aliquid
								consequuntur cumque quasi.
								Perspiciatis.
							</p>
						</div>
					</div>
					<div class="col-md-4 col-md-pull-7">
						<div class="booking-form">
							<form id="form">
								<div class="">
									<div class="form-group">
										<span class="form-label">Your Name</span>
										<input id="memID" class="form-control" type="text" placeholder="Enter Name">
									</div>
								</div>
								<div class="form-group">
									<span class="form-label">備註</span>
									<input id="bookingNote" class="form-control" type="text" placeholder="Enter">
								</div>
								<div class="form-group">
									<span class="form-label">Store</span>
									<select id="store" class="form-control">
										<!-- <option id="option1" value="-1">門市選擇</option> -->
									</select>
									<span class="select-arrow"></span>
								</div>
								<div class="row">
									<div class="col-sm-6">
										<div class="form-group">
											<span class="form-label">Booking Date</span>
											<input id="bookingDate" name="bookingDate" placeholder="Booking Date"
												class="form-control" type="text" required autocomplete="off">
										</div>
									</div>
									<div class="col-sm-6">
										<div class="form-group">
											<span class="form-label">包廂</span>
											<select id="boxSize" class="form-control">
											</select>
											<span class="select-arrow"></span>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-4">
										<div class="form-group">
											<span class="form-label">起始時間</span>
											<select id="bookingStart" class="form-control">
												<!-- 自動生成起始時間 -->
											</select>
											<span class="select-arrow"></span>
										</div>
									</div>
									<div class="col-sm-4">
										<div class="form-group">
											<span class="form-label">結束時間</span>
											<select id="bookingEnd" class="form-control">
												<!-- <option>11:00</option> -->
												<!-- 自動生成結束時間 -->
											</select>
											<span class="select-arrow"></span>
										</div>
									</div>
									<div class="form-btn">
										<button type="button" name="booking-btn" id="btn1" class="submit-btn"
											onclick="bookingBtn()">Check
											availability</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		window.addEventListener("load", function () {
			let memID = document.getElementById('memID');
			let store = document.getElementById('store');
			let option1 = document.getElementById('option1');
			let bookingDate = document.getElementById('bookingDate');
			let range = document.getElementById('range')
			let boxSize = document.getElementById("boxSize");
			let bookingStart = document.getElementById('bookingStart');
			let bookingEnd = document.getElementById('bookingEnd');
			let index = 0;

			// store設定 -----------------------------------------------------------------------------------		
			fetch("http://localhost:8081/CGA103G3_07/store/store.do")
				.then(res => res.json("storeList"))
				.then(storeList => {
					let add = '';
					for (let i = 0; i <= storeList.length; i++) {
						add = '';
						add += '<option value="0" selected="selected">選擇門市</option>';
						for (let j = 0; j < i; j++) {
							add += '<option value="' + storeList[j].storeID + '">' + storeList[j].storeName + '</option>';
						};
						store.innerHTML = add;
					};
				});

			// 包廂-------------------------------------------------------------------------------------------
			document.getElementById('store').addEventListener('change', box => {
				// console.log(store.value);
				fetch("http://localhost:8081/CGA103G3_07/box/box.do")
					.then(res => res.json("allBox"))
					.then(allBox => {
						// console.log(allBox);
						let add = '';
						add += '<option value="0" selected="selected">選擇包廂</option>';
						for (let i = 0; i < allBox.length; i++) {
							if (store.value == allBox[i].storeID) {
								add += '<option value="' + allBox[i].boxID + '">' + allBox[i].boxDescription + '</option>';
							}
							boxSize.innerHTML = add;
						}
					})
			})


			//指定每周固定日
			$("#bookingDate").datepicker({
				minDate: 1,
				maxDate: "15D",
				dateFormat: "yy-mm-dd"
				// beforeShowDay: nationalDays
				// beforeShowDay: function (date1) { return [date1.getDay() != 2, '']; }
			});

			//修改中=========================================================================================================================

			// 如有訂單轉跳至此方法
			function bookingMethod() {
				fetch("http://localhost:8081/CGA103G3_07/BookingSet/BookingSet.do")
					.then(res => res.json("allBooking"))
					.then(allBooking => {
						console.log('bookingMethod()');
						let add = '';
						for (let i = 0; i < allBooking.length; i++) {
							add = '';
							add += '<option value="0" selected="selected">選擇時間</option>';
							if (allBooking[i].boxID == boxSize.value && bookingDate.value == allBooking[i].bookingDate) {
								for (let start = allBooking[i].boxBkStart; start < allBooking[i].bookingStart; start++) {
									add += '<option value="' + start + '">' + start + ':00' + '</option>';
								}
								for (let start = allBooking[i].bookingEnd; start < allBooking[i].boxBkEnd; start++) {
									add += '<option value="' + start + '">' + start + ':00' + '</option>';
								}
								bookingStart.innerHTML = add;
							}
						};
					});
			}

			//修改中=========================================================================================================================
			// $('#bookingDate').on('change', function () )}


			document.getElementById('boxSize').addEventListener('change', () => {
				console.log('來自包廂資訊= ' + boxSize.value);
				fetch("http://localhost:8081/CGA103G3_07/BookingSet/BookingSet.do")
					.then(res => res.json("allBooking"))
					.then(allBooking => {
						let getBox = '';
						let getBoxBkStart = '';
						let getBoxBkEnd = '';
						let add = '';
						for (let i = 0; i < allBooking.length; i++) {
							add = '';
							add += '<option value="0" selected="selected">選擇時間</option>';
							if (allBooking[i].boxID == boxSize.value) {
								console.log('取得getBox = boxSize.value');
								getBox = allBooking[i].boxID;
								getBoxBkStart = allBooking[i].boxBkStart;
								getBoxBkEnd = allBooking[i].boxBkEnd;
								console.log('getBoxBkStart= ' + getBoxBkStart);
								console.log('getBoxBkEnd= ' + getBoxBkEnd);
							}
						};
						for (let i = 0; i < allBooking.length; i++) {
							if (allBooking[i].boxID == boxSize.value && bookingDate.value == allBooking[i].bookingDate) {
								bookingMethod()
								console.log('有訂位資料轉送bookingMethod');
								return;
							}
						};
						for (let start = getBoxBkStart; start < getBoxBkEnd; start++) {
							add += '<option value="' + start + '">' + start + ':00' + '</option>';
						}
						bookingStart.innerHTML = add;
						console.log('boxSize結束')
					});
			})

			// 結束時間設定-----------------------------------------------------------------------------------------------
			document.getElementById('bookingStart').addEventListener('change', e => {
				fetch("http://localhost:8081/CGA103G3_07/BookingSet/BookingSet.do")
					.then(res => res.json("allBooking"))
					.then(allBooking => {
						let add = '';
						let end = bookingStart.value; //取得訂位選取起始時間
						let getBookingStart = '';
						let getBookingEnd = '';
						let getBoxBkEnd = '';
						for (let i = 0; i < allBooking.length; i++) {
							if (allBooking[i].boxID == boxSize.value && bookingDate.value == allBooking[i].bookingDate) {
								setBookingEndTime();
								return;
							}
							if (allBooking[i].boxID == boxSize.value) {
								getBoxBkEnd = allBooking[i].boxBkEnd;
								noBooking();
								return;
							}
						}
						function noBooking() {
							add += '<option value="0" selected="selected">選擇結束時間</option>';
							for (let start = ++end; start <= getBoxBkEnd; start++) {
								console.log('這是bookingStart監聽地方');
								add += '<option value="' + start + '">' + start + ':00' + '</option>';
							}
							bookingEnd.innerHTML = add;
						}
					})
			})

			// 設定已有預定的日期包廂之剩餘結束時間
			function setBookingEndTime() {
				fetch("http://localhost:8081/CGA103G3_07/BookingSet/BookingSet.do")
					.then(res => res.json("allBooking"))
					.then(allBooking => {
						let end = bookingStart.value; //取得訂位選取起始時間
						let getBookingStart = '';
						let getBookingEnd = '';
						let getBoxBkEnd = '';
						let add = '';
						console.log('來自setBookingEndTime()的訊息');
						console.log('來自setBookingEndTime()的訊息bookingStart.value= ' + end);

						for (let i = 0; i < allBooking.length; i++) {
							if (allBooking[i].boxID == boxSize.value && bookingDate.value == allBooking[i].bookingDate) {
								getBookingStart = allBooking[i].bookingStart;
								getBookingEnd = allBooking[i].bookingEnd;
								getBoxBkEnd = allBooking[i].boxBkEnd;
							}
						}
						if (end < getBookingStart) { 	// 如果預訂時間在已預訂的開始時間前，預訂起始時間 -> 已預訂的起始時間
							for (let start = ++end; start <= getBookingStart; start++) {
								add += '<option value="' + start + '">' + start + ':00' + '</option>';
							}
							bookingEnd.innerHTML = add;
						} else if (end > getBookingStart) { 	// 如果預訂的時間在已預訂時間之後，預訂的結束時間 -> 包廂設定結束時間
							console.log('來自setBookingEndTime()方法的getBoxBkEnd= ' + getBoxBkEnd);
							for (let getBookingEnd = ++end; getBookingEnd <= getBoxBkEnd; getBookingEnd++) {
								add += '<option value="' + getBookingEnd + '">' + getBookingEnd + ':00' + '</option>';
							}
							bookingEnd.innerHTML = add;
							return;
						}
					})
			}

			//修改中=========================================================================================================================

			// 指定每周固定日
			// $("#bookingDate").datepicker({
			// 	minDate: 0,
			// 	maxDate: "15D",
			// 	dateFormat: "yy-mm-dd"
			// 	// beforeShowDay: nationalDays
			// 	// beforeShowDay: function (date1) { return [date1.getDay() != 2, '']; }
			// });

			// 日期 限定日期不可選
			//https://www.796t.com/content/1550233634.html
			// natDays = [
			// 	[2022, 08, 17], [2022, 08, 20], [2022, 08, 30], [2022, 08, 23]
			// ];

			// function nationalDays(date) {
			// 	for (i = 0; i < natDays.length; i++) {
			// 		if (date.getFullYear() == natDays[i][0] && date.getMonth() == natDays[i][1] - 1
			// 			&& date.getDate() == natDays[i][2]) {
			// 			return [false, natDays[i][0] + '_day'];
			// 		}
			// 	}
			// 	return [true, ''];
			// }

			//指定每周固定日
			//https://jsfiddle.net/RaYZ5/19/
			// $("#bookingDate").datepicker({
			// 	minDate: 0,
			// 	maxDate: "15D",
			// 	dateFormat: "yy-mm-dd",
			// 	// beforeShowDay: nationalDays
			// 	beforeShowDay: function (date1) { return [date1.getDay() != 2, '']; }
			// });

		});

		//submit
		function bookingBtn() {
			if (store.value == '選擇門市' || store.value == 0) {
				alert('未選擇門市');
				return;
			}

			if (boxSize.value == 0 || boxSize.value == '選擇包廂') {
				alert('請選擇包廂');
				return;
			}

			if (bookingStart == 0 || bookingStart == '選擇時間') {
				alert('訂位起始時間有誤，請重新選取');
				return;
			}

			if (bookingEnd == 0 || bookingEnd == '選擇時間') {
				alert('訂位結束時間有誤，請重新選取');
				return;
			}

			if (memID.value == '') {
				alert('請輸入會員資料');
				return;
			}

			if (bookingDate.value == '') {
				alert('請選擇預訂日期');
				return;
			}
			console.log(memID.value, store.value, boxSize.value, bookingDate.value, bookingStart.value, bookingEnd.value, bookingNote.value);
			document.getElementById('form').submit();

			fetch("http://localhost:8081/CGA103G3_07/bookingorderfetch/bookingorder.do", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					memID: memID.value,
					bookingDate: bookingDate.value,
					bookingStart: bookingStart.value,
					bookingEnd: bookingEnd.value,
					boxID: boxSize.value,
					bookingNote: bookingNote.value
				})
			})
				.then(res => {
					if (response.ok) {
						return response.json();
					} else {
						const { status, statusText } = response;
						throw Error(`${status}: ${statusText}`);
					}
				})
				.then(obj => console.log(obj))
				.catch(({ message }) => div.textContent = message);

			alert('預訂成功');


		}
	</script>
</body><!-- This templates was made by Colorlib (https://colorlib.com) -->

</html>